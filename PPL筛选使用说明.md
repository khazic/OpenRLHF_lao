# PPLæ•°æ®ç­›é€‰å·¥å…· - ä½¿ç”¨è¯´æ˜

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

è¿™å¥—å·¥å…·å¯ä»¥å¸®åŠ©ä½ ï¼š
1. è®¡ç®—æ•°æ®é›†ä¸­æ¯ä¸ªæ ·æœ¬çš„PPLï¼ˆå›°æƒ‘åº¦ï¼‰
2. åŸºäºPPLé˜ˆå€¼ç­›é€‰é«˜è´¨é‡æ•°æ®
3. æ‰¹é‡å¤„ç†å¤šä¸ªæ•°æ®é›†
4. ç”Ÿæˆè¯¦ç»†çš„ç»Ÿè®¡æŠ¥å‘Š

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### æ­¥éª¤1ï¼šæŸ¥çœ‹æ‰€æœ‰æ•°æ®é›†çš„æ ·æœ¬æ•°

```bash
python count_all_samples.py /xfr_ceph_sh/liuchonghan/sft_dataset
```

**è¾“å‡ºç¤ºä¾‹ï¼š**
```
ğŸ“Š æ•°æ®é›†æ ·æœ¬æ•°ç»Ÿè®¡
================================================================================
æ‰¾åˆ° 5 ä¸ªJSONæ–‡ä»¶
================================================================================

åºå·   æ–‡ä»¶å                                              æ ·æœ¬æ•°      å¤‡æ³¨
--------------------------------------------------------------------------------
1      SFT_EN_QA.json                                       850       ğŸ“ åŸå§‹æ•°æ®
2      SFT_Math.json                                       1200       ğŸ“ åŸå§‹æ•°æ®
3      SFT_Code.json                                        650       ğŸ“ åŸå§‹æ•°æ®
...

ğŸ“ˆ æ±‡æ€»ç»Ÿè®¡
åŸå§‹æ•°æ®é›†æ€»æ ·æœ¬æ•°: 2,700
```

---

### æ­¥éª¤2ï¼šæ‰¹é‡å¤„ç†æ‰€æœ‰æ•°æ®é›†

```bash
bash filter_all_datasets.sh
```

**è¿™ä¸ªè„šæœ¬ä¼šï¼š**
- è‡ªåŠ¨æ‰¾åˆ°æ‰€æœ‰JSONæ–‡ä»¶
- å¯¹æ¯ä¸ªæ–‡ä»¶è®¡ç®—PPL
- æ ¹æ®é˜ˆå€¼ç­›é€‰æ•°æ®
- ç”Ÿæˆè¯¦ç»†æŠ¥å‘Š

**è¾“å‡ºæ–‡ä»¶ï¼ˆæ¯ä¸ªæ•°æ®é›†ä¼šç”Ÿæˆ4ä¸ªæ–‡ä»¶ï¼‰ï¼š**
```
SFT_EN_QA_ppl1.0_all.json        - æ‰€æœ‰æ ·æœ¬åŠå…¶PPLï¼ˆæŒ‰PPLæ’åºï¼‰
SFT_EN_QA_ppl1.0_filtered.json   - â­ ç­›é€‰åçš„é«˜è´¨é‡æ•°æ®ï¼ˆç”¨äºè®­ç»ƒï¼‰
SFT_EN_QA_ppl1.0_removed.json    - è¢«åˆ é™¤çš„ä½è´¨é‡æ•°æ®
SFT_EN_QA_ppl1.0_summary.txt     - ğŸ“‹ è¯¦ç»†æ±‡æ€»æŠ¥å‘Š
```

---

### æ­¥éª¤3ï¼šæŸ¥çœ‹ç­›é€‰ç»“æœ

#### æŸ¥çœ‹æ‰¹å¤„ç†æ±‡æ€»ï¼š
```bash
cat /xfr_ceph_sh/liuchonghan/sft_dataset/batch_ppl_filter_summary_*.txt
```

#### æŸ¥çœ‹å•ä¸ªæ•°æ®é›†çš„è¯¦ç»†æŠ¥å‘Šï¼š
```bash
cat /xfr_ceph_sh/liuchonghan/sft_dataset/SFT_EN_QA_ppl1.0_summary.txt
```

#### å†æ¬¡ç»Ÿè®¡æ ·æœ¬æ•°ï¼ˆæŸ¥çœ‹ç­›é€‰æ•ˆæœï¼‰ï¼š
```bash
python count_all_samples.py /xfr_ceph_sh/liuchonghan/sft_dataset
```

---

## âš™ï¸ é…ç½®è¯´æ˜

### ä¿®æ”¹PPLé˜ˆå€¼

ç¼–è¾‘ `filter_all_datasets.sh`ï¼Œä¿®æ”¹ç¬¬7è¡Œï¼š

```bash
PPL_THRESHOLD=1.0  # æ”¹æˆä½ æƒ³è¦çš„é˜ˆå€¼
```

**æ¨èé˜ˆå€¼ï¼š**
- `1.0` - æä¸¥æ ¼ï¼ˆåªä¿ç•™æ¨¡å‹æœ€ç†Ÿæ‚‰çš„æ•°æ®ï¼‰
- `5.0` - ä¸¥æ ¼ï¼ˆä¿ç•™é«˜è´¨é‡æ•°æ®ï¼‰
- `10.0` - ä¸­ç­‰ï¼ˆå¹³è¡¡è´¨é‡å’Œæ•°é‡ï¼‰
- `20.0` - å®½æ¾ï¼ˆåªåˆ é™¤æ˜æ˜¾çš„å¼‚å¸¸æ ·æœ¬ï¼‰

### ä¿®æ”¹å­—æ®µå

å¦‚æœä½ çš„æ•°æ®é›†ä½¿ç”¨ä¸åŒçš„å­—æ®µåï¼Œç¼–è¾‘ç¬¬10-11è¡Œï¼š

```bash
INPUT_KEY="question"   # æ”¹æˆä½ çš„è¾“å…¥å­—æ®µå
OUTPUT_KEY="response"  # æ”¹æˆä½ çš„è¾“å‡ºå­—æ®µå
```

---

## ğŸ“Š è¾“å‡ºæ–‡ä»¶è¯´æ˜

### 1. `*_filtered.json` - ç­›é€‰åçš„é«˜è´¨é‡æ•°æ® â­
**è¿™æ˜¯ä½ è¦ç”¨äºè®­ç»ƒçš„æ–‡ä»¶ï¼**

æ ¼å¼ï¼š
```json
[
  {
    "question": "...",
    "response": "..."
  },
  ...
]
```

### 2. `*_all.json` - æ‰€æœ‰æ ·æœ¬çš„PPLè¯¦æƒ…
åŒ…å«æ¯ä¸ªæ ·æœ¬çš„PPLå€¼ï¼ŒæŒ‰PPLä»ä½åˆ°é«˜æ’åº

æ ¼å¼ï¼š
```json
[
  {
    "index": 0,
    "ppl": 1.05,
    "loss": 0.0488,
    "num_tokens": 234,
    "question": "...",
    "response": "..."
  },
  ...
]
```

### 3. `*_removed.json` - è¢«åˆ é™¤çš„ä½è´¨é‡æ•°æ®
åŒ…å«PPLè¶…è¿‡é˜ˆå€¼çš„æ ·æœ¬

### 4. `*_summary.txt` - è¯¦ç»†ç»Ÿè®¡æŠ¥å‘Š
åŒ…å«ï¼š
- æ ·æœ¬æ•°é‡ç»Ÿè®¡
- PPLåˆ†å¸ƒä¿¡æ¯
- ä¿ç•™/åˆ é™¤æ¯”ä¾‹
- æ–‡ä»¶è·¯å¾„

---

## ğŸ¯ å¸¸è§ä½¿ç”¨åœºæ™¯

### åœºæ™¯1ï¼šåªå¤„ç†å•ä¸ªæ•°æ®é›†

ç¼–è¾‘ `filter_dataset_by_ppl.sh`ï¼Œè®¾ç½®æ•°æ®é›†è·¯å¾„ï¼š

```bash
DATASET_PATH="/xfr_ceph_sh/liuchonghan/sft_dataset/SFT_EN_QA.json"
```

è¿è¡Œï¼š
```bash
bash filter_dataset_by_ppl.sh
```

### åœºæ™¯2ï¼šä½¿ç”¨ä¸åŒçš„é˜ˆå€¼æµ‹è¯•

```bash
# æµ‹è¯•é˜ˆå€¼ 5.0
sed -i 's/PPL_THRESHOLD=.*/PPL_THRESHOLD=5.0/' filter_all_datasets.sh
bash filter_all_datasets.sh

# æµ‹è¯•é˜ˆå€¼ 10.0
sed -i 's/PPL_THRESHOLD=.*/PPL_THRESHOLD=10.0/' filter_all_datasets.sh
bash filter_all_datasets.sh
```

ç„¶åå¯¹æ¯”ä¸¤ä¸ªé˜ˆå€¼çš„ç»“æœï¼Œé€‰æ‹©æœ€åˆé€‚çš„ã€‚

### åœºæ™¯3ï¼šæŸ¥çœ‹PPLåˆ†å¸ƒå†³å®šé˜ˆå€¼

å…ˆä¸è®¾ç½®é˜ˆå€¼ï¼Œåªåˆ†æPPLåˆ†å¸ƒï¼š

ä¿®æ”¹ `calculate_ppl_per_sample.py` çš„è°ƒç”¨ï¼Œä¸ä¼  `--ppl_threshold`ï¼š

```bash
deepspeed --num_gpus 8 calculate_ppl_per_sample.py \
    --pretrain ${MODEL_PATH} \
    --dataset ${DATASET_PATH} \
    --input_key question \
    --output_key response \
    --max_len 4096 \
    --bf16 \
    --zero_stage 0 \
    --output_file analysis.json
```

æŸ¥çœ‹ `analysis_all.json`ï¼Œæ ¹æ®PPLåˆ†å¸ƒå†³å®šåˆé€‚çš„é˜ˆå€¼ã€‚

---

## ğŸ“ˆ PPLå€¼è§£è¯»

| PPLèŒƒå›´ | å«ä¹‰ | å»ºè®® |
|---------|------|------|
| 1-5 | æ¨¡å‹éå¸¸ç†Ÿæ‚‰ | ä¼˜è´¨æ•°æ®ï¼Œä¿ç•™ |
| 5-10 | æ¨¡å‹ç†è§£è‰¯å¥½ | é«˜è´¨é‡æ•°æ®ï¼Œä¿ç•™ |
| 10-20 | æ¨¡å‹åŸºæœ¬ç†è§£ | å¯æ¥å—çš„æ•°æ® |
| 20-50 | æ¨¡å‹ç†è§£å›°éš¾ | è€ƒè™‘åˆ é™¤ |
| >50 | æ¨¡å‹å‡ ä¹ä¸ç†è§£ | å»ºè®®åˆ é™¤ |

---

## ğŸ”§ æ•…éšœæ’é™¤

### é—®é¢˜1ï¼šæ˜¾å­˜ä¸è¶³
**é”™è¯¯ä¿¡æ¯ï¼š** `CUDA out of memory`

**è§£å†³æ–¹æ³•ï¼š**
ç¼–è¾‘è„šæœ¬ï¼Œé™ä½ batch sizeï¼ˆè™½ç„¶å·²ç»æ˜¯1äº†ï¼Œä½†å¯ä»¥å‡å°‘GPUæ•°é‡ï¼‰ï¼š
```bash
deepspeed --num_gpus 4 calculate_ppl_per_sample.py ...  # ä»8æ”¹æˆ4
```

### é—®é¢˜2ï¼šåºåˆ—å¤ªé•¿
**è§£å†³æ–¹æ³•ï¼š**
é™ä½ `--max_len`ï¼š
```bash
--max_len 2048  # ä»4096æ”¹æˆ2048
```

### é—®é¢˜3ï¼šå­—æ®µåä¸åŒ¹é…
**é”™è¯¯ä¿¡æ¯ï¼š** `KeyError: 'question'`

**è§£å†³æ–¹æ³•ï¼š**
æ£€æŸ¥ä½ çš„JSONæ•°æ®æ ¼å¼ï¼Œä¿®æ”¹ `INPUT_KEY` å’Œ `OUTPUT_KEY`ã€‚

---

## ğŸ“ æ–‡ä»¶æ¸…å•

| æ–‡ä»¶å | ç”¨é€” |
|--------|------|
| `calculate_ppl_per_sample.py` | æ ¸å¿ƒè„šæœ¬ï¼šè®¡ç®—æ¯ä¸ªæ ·æœ¬çš„PPL |
| `filter_all_datasets.sh` | æ‰¹é‡å¤„ç†å¤šä¸ªæ•°æ®é›† â­ |
| `filter_dataset_by_ppl.sh` | å¤„ç†å•ä¸ªæ•°æ®é›† |
| `count_all_samples.py` | ç»Ÿè®¡æ‰€æœ‰JSONæ–‡ä»¶çš„æ ·æœ¬æ•° |
| `PPLç­›é€‰ä½¿ç”¨è¯´æ˜.md` | æœ¬æ–‡æ¡£ |

---

## âœ… å®Œæ•´å·¥ä½œæµç¨‹ç¤ºä¾‹

```bash
# 1. æŸ¥çœ‹ç°æœ‰æ•°æ®é›†
python count_all_samples.py /xfr_ceph_sh/liuchonghan/sft_dataset

# è¾“å‡ºï¼š
# åŸå§‹æ•°æ®é›†: 5ä¸ªæ–‡ä»¶ï¼Œå…±2,700æ ·æœ¬

# 2. æ‰¹é‡ç­›é€‰
bash filter_all_datasets.sh

# è¿è¡Œä¸­...
# [1/5] å¤„ç†: SFT_EN_QA.json
#   åŸå§‹æ ·æœ¬æ•°: 850
#   âœ… ä¿ç•™: 723 (85.1%) | åˆ é™¤: 127
# ...

# 3. æŸ¥çœ‹ç»“æœ
python count_all_samples.py /xfr_ceph_sh/liuchonghan/sft_dataset

# è¾“å‡ºï¼š
# åŸå§‹æ•°æ®é›†: 2,700æ ·æœ¬
# ç­›é€‰åæ•°æ®é›†: 2,301æ ·æœ¬ (ä¿ç•™ç‡85.2%)

# 4. æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Š
cat /xfr_ceph_sh/liuchonghan/sft_dataset/batch_ppl_filter_summary_*.txt

# 5. ä½¿ç”¨ç­›é€‰åçš„æ•°æ®è®­ç»ƒ
# æ‰€æœ‰ *_filtered.json æ–‡ä»¶å°±æ˜¯é«˜è´¨é‡æ•°æ®ï¼
```

---

## ğŸ’¡ æœ€ä½³å®è·µ

1. **å…ˆç»Ÿè®¡ï¼Œåç­›é€‰**ï¼šè¿è¡Œ `count_all_samples.py` äº†è§£æ•°æ®è§„æ¨¡
2. **é€‰æ‹©åˆé€‚çš„é˜ˆå€¼**ï¼šæ ¹æ®æ•°æ®é›†å¤§å°å’Œè´¨é‡è¦æ±‚é€‰æ‹©
3. **ä¿ç•™ä¸­é—´æ–‡ä»¶**ï¼š`*_all.json` å¯ä»¥å¸®åŠ©ä½ åˆ†æPPLåˆ†å¸ƒ
4. **å¤‡ä»½åŸå§‹æ•°æ®**ï¼šç­›é€‰ä¸ä¼šä¿®æ”¹åŸæ–‡ä»¶ï¼Œä½†å»ºè®®å¤‡ä»½
5. **æŸ¥çœ‹æ±‡æ€»æŠ¥å‘Š**ï¼šæ¯æ¬¡å¤„ç†åæ£€æŸ¥ `*_summary.txt`

---

## ğŸ‰ å®Œæˆå

ç­›é€‰å®Œæˆåï¼Œä½ çš„ç›®å½•ç»“æ„ï¼š

```
/xfr_ceph_sh/liuchonghan/sft_dataset/
â”œâ”€â”€ SFT_EN_QA.json                          # åŸå§‹æ–‡ä»¶
â”œâ”€â”€ SFT_EN_QA_ppl1.0_filtered.json         # â­ ç”¨è¿™ä¸ªè®­ç»ƒï¼
â”œâ”€â”€ SFT_EN_QA_ppl1.0_all.json
â”œâ”€â”€ SFT_EN_QA_ppl1.0_removed.json
â”œâ”€â”€ SFT_EN_QA_ppl1.0_summary.txt
â”œâ”€â”€ SFT_Math.json
â”œâ”€â”€ SFT_Math_ppl1.0_filtered.json          # â­ ç”¨è¿™ä¸ªè®­ç»ƒï¼
â”œâ”€â”€ ...
â””â”€â”€ batch_ppl_filter_summary_xxx.txt       # ğŸ“‹ æ€»æ±‡æ€»
```

**åœ¨è®­ç»ƒè„šæœ¬ä¸­ä½¿ç”¨ç­›é€‰åçš„æ•°æ®ï¼š**
```bash
--dataset /xfr_ceph_sh/liuchonghan/sft_dataset/SFT_EN_QA_ppl1.0_filtered.json
```

